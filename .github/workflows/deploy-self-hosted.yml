name: Deploy to Production (Self-hosted)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.10.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Generate Prisma Client
        run: npx prisma generate

      # Áõ¥Êé•Êú¨Âú∞ÈÉ®ÁΩ≤ÔºåÊó†ÈúÄ SSH/SCP
      - name: Deploy to production
        run: |
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # Â§á‰ªΩÁéØÂ¢ÉÂèòÈáèÊñá‰ª∂
          if [ -f /home/apps/open-api/.env ]; then
            cp /home/apps/open-api/.env /tmp/open-api.env.backup
            echo "‚úÖ Backed up .env file"
          fi
          
          # Â§á‰ªΩÊóßÁâàÊú¨
          if [ -d /home/apps/open-api ]; then
            BACKUP_NAME="open-api.backup.$(date +%Y%m%d_%H%M%S)"
            sudo mv /home/apps/open-api "/home/apps/$BACKUP_NAME"
            echo "‚úÖ Backed up old version to $BACKUP_NAME"
          fi
          
          # ÂàõÂª∫ÈÉ®ÁΩ≤ÁõÆÂΩï
          sudo mkdir -p /home/apps/open-api
          echo "üìÅ Created deployment directory"
          
          # Â§çÂà∂ÊûÑÂª∫‰∫ßÁâ©
          sudo cp -r dist /home/apps/open-api/
          sudo cp -r node_modules /home/apps/open-api/
          sudo cp -r prisma /home/apps/open-api/
          sudo cp package.json /home/apps/open-api/
          sudo cp package-lock.json /home/apps/open-api/
          echo "üì¶ Copied build artifacts"
          
          # ÊÅ¢Â§çÁéØÂ¢ÉÂèòÈáèÊñá‰ª∂
          if [ -f /tmp/open-api.env.backup ]; then
            sudo cp /tmp/open-api.env.backup /home/apps/open-api/.env
            rm /tmp/open-api.env.backup
            echo "‚úÖ Restored .env file"
          else
            echo "‚ö†Ô∏è  No .env backup found, please create it manually at /home/apps/open-api/.env"
          fi
          
          # ËÆæÁΩÆÊùÉÈôê
          sudo chown -R root:root /home/apps/open-api
          
          # ÈáçÂêØÊúçÂä° (‰ΩøÁî® PM2)
          cd /home/apps/open-api
          sudo pm2 restart open-api || sudo pm2 start dist/src/main.js --name open-api
          sudo pm2 save
          echo "üîÑ Service restarted"
          
          # Ê∏ÖÁêÜÊóßÂ§á‰ªΩÔºàÂè™‰øùÁïôÊúÄËøë3‰∏™Ôºâ
          cd /home/apps
          sudo ls -t | grep "open-api.backup" | tail -n +4 | sudo xargs -r rm -rf
          echo "üßπ Cleaned up old backups"
          
          echo "‚úÖ Deployment completed successfully!"

      # ÂÅ•Â∫∑Ê£ÄÊü•
      - name: Health check
        run: |
          echo "üè• Running health check..."
          sleep 10
          
          if curl --fail --silent http://localhost:3001/health > /dev/null 2>&1; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ùå Health check failed!"
            exit 1
          fi

      # ÊòæÁ§∫ÈÉ®ÁΩ≤‰ø°ÊÅØ
      - name: Deployment summary
        if: always()
        run: |
          echo "========================================="
          echo "  Deployment Summary"
          echo "========================================="
          echo "Deployed to: /home/apps/open-api"
          echo "PM2 Status:"
          sudo pm2 list | grep open-api || echo "Service not found"
          echo "========================================="
