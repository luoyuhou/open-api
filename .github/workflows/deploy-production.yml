name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.10.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Generate Prisma Client
        run: npx prisma generate

      # æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp -r node_modules deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp -r prisma deploy/
          cd deploy && tar -czf ../deploy.tar.gz .
      # ä¸Šä¼ åˆ°æœåŠ¡å™¨
      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp"
          overwrite: true


      # åœ¨æœåŠ¡å™¨ä¸Šè§£å‹å¹¶é‡å¯æœåŠ¡
      - name: Extract and restart service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # ğŸ”‘ å¤‡ä»½ç¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f /home/apps/open-api/.env ]; then
              cp /home/apps/open-api/.env /tmp/open-api.env.backup
              echo "âœ… Backed up .env file"
            fi
            
            # å¤‡ä»½æ—§ç‰ˆæœ¬
            if [ -d /home/apps/open-api ]; then
              mv /home/apps/open-api /home/apps/open-api.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # è§£å‹æ–°ç‰ˆæœ¬
            mkdir -p /home/apps/open-api
            tar -xzf /tmp/deploy.tar.gz -C /home/apps/open-api
            
            # ğŸ”‘ æ¢å¤ç¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f /tmp/open-api.env.backup ]; then
              cp /tmp/open-api.env.backup /home/apps/open-api/.env
              rm /tmp/open-api.env.backup
              echo "âœ… Restored .env file"
            else
              echo "âš ï¸ No .env backup found, please create it manually"
            fi
            
            # ç”Ÿæˆ Prisma Client
            cd /home/apps/open-api
            npx prisma generate
            echo 'Prisma Client generated'
            
            # é‡å¯æœåŠ¡ (ä½¿ç”¨ PM2)
            pm2 restart open-api || pm2 start dist/src/main.js --name open-api
            echo 'Service restarted'
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm /tmp/deploy.tar.gz
            
            # åªä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½
            cd /home/apps && ls -t | grep open-api.backup | tail -n +4 | xargs -r rm -rf
            echo 'Cleanup completed'
      # å¥åº·æ£€æŸ¥
      - name: Health check
        run: |
          sleep 10
          curl --fail http://${{ secrets.SERVER_HOST }}:3001/api || exit 1