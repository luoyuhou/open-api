name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.10.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Generate Prisma Client
        run: npx prisma generate

      # æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp -r node_modules deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp -r prisma deploy/
          cd deploy && tar -czf ../deploy.tar.gz .

      # ä½¿ç”¨ SSH + tar ä¼ è¾“ï¼ˆä¸ä¾èµ– SFTPï¼‰
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
      - name: Add known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Upload to server via SSH
        run: |
          cat deploy.tar.gz | ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'cat > ~/deploy.tar.gz'

      # åœ¨æœåŠ¡å™¨ä¸Šè§£å‹å¹¶é‡å¯æœåŠ¡
      - name: Extract and restart service
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' << 'ENDSSH'
            # ğŸ”‘ å¤‡ä»½ç¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f /home/apps/open-api/.env ]; then
              cp /home/apps/open-api/.env ~/open-api.env.backup
              echo "âœ… Backed up .env file"
            fi
            
            # å¤‡ä»½æ—§ç‰ˆæœ¬
            if [ -d /home/apps/open-api ]; then
              mv /home/apps/open-api ~/open-api.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # è§£å‹æ–°ç‰ˆæœ¬
            mkdir -p /home/apps/open-api
            tar -xzf ~/deploy.tar.gz -C /home/apps/open-api
            
            # ğŸ”‘ æ¢å¤ç¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f ~/open-api.env.backup ]; then
              cp ~/open-api.env.backup /home/apps/open-api/.env
              rm ~/open-api.env.backup
              echo "âœ… Restored .env file"
            else
              echo "âš ï¸ No .env backup found, please create it manually"
            fi
            
            # é‡å¯æœåŠ¡ (ä½¿ç”¨ PM2)
            cd /home/apps/open-api
            pm2 restart open-api || pm2 start dist/src/main.js --name open-api
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm ~/deploy.tar.gz
            
            # åªä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½
            cd ~ && ls -t | grep open-api.backup | tail -n +4 | xargs -r rm -rf
          ENDSSH

      # å¥åº·æ£€æŸ¥
      - name: Health check
        run: |
          sleep 10
          curl --fail http://${{ secrets.SERVER_HOST }}:3001/health || exit 1
