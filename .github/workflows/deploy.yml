name: Deploy Backend to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # ‚úÖ Âú® GitHub ‰∫ëÁ´ØÊûÑÂª∫Ôºå‰∏çÂç†Áî®‰Ω†ÁöÑÊúçÂä°Âô®
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.10.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Generate Prisma Client
        run: npx prisma generate

      # ÊâìÂåÖÊûÑÂª∫‰∫ßÁâ©‰∏∫ tar.gz
      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp -r node_modules deploy/
          cp -r prisma deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cd deploy && tar -czf ../deploy.tar.gz .

      # SSH ‰º†Ëæì
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
      - name: Add known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Upload to server via SSH
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/deploy-backend.tar.gz

      # Ëß£ÂéãÂπ∂ÈáçÂêØ
      - name: Extract and restart
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            /bin/sh << 'ENDSH'
          set -e
          
          echo "Starting backend deployment..."
          
          # Â§á‰ªΩÁéØÂ¢ÉÂèòÈáèÊñá‰ª∂
          if [ -f /home/apps/open-api/.env ]; then
            cp /home/apps/open-api/.env ~/open-api.env.backup
            echo "Backed up .env"
          fi
          
          # Â§á‰ªΩÊóßÁâàÊú¨
          if [ -d /home/apps/open-api ]; then
            BACKUP_NAME="open-api.backup.$(date +%Y%m%d_%H%M%S)"
            mv /home/apps/open-api ~/"$BACKUP_NAME"
            echo "Backed up old version to $BACKUP_NAME"
          fi
          
          # ÈÉ®ÁΩ≤
          mkdir -p /home/apps/open-api
          tar -xzf ~/deploy-backend.tar.gz -C /home/apps/open-api
          echo "Extracted files"
          
          # ÊÅ¢Â§çÁéØÂ¢ÉÂèòÈáèÊñá‰ª∂
          if [ -f ~/open-api.env.backup ]; then
            cp ~/open-api.env.backup /home/apps/open-api/.env
            rm ~/open-api.env.backup
            echo "Restored .env"
          else
            echo "No .env backup found, please create it manually at /home/apps/open-api/.env"
          fi
          
          # ÈáçÂêØÊúçÂä°
          cd /home/apps/open-api
          pm2 restart open-api || pm2 start dist/src/main.js --name open-api
          pm2 save
          echo "Service restarted"
          
          # Ê∏ÖÁêÜ
          rm ~/deploy-backend.tar.gz
          cd ~ && ls -t | grep open-api.backup | tail -n +4 | xargs -r rm -rf
          echo "Cleaned up old backups"
          
          echo "Backend deployment completed!"
          ENDSH

      # ÂÅ•Â∫∑Ê£ÄÊü•
      - name: Health check
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            echo 'üè• Running health check...'
            sleep 10
            
            if curl --fail --silent http://localhost:3001/health > /dev/null 2>&1; then
              echo '‚úÖ Health check passed!'
            else
              echo '‚ùå Health check failed!'
              exit 1
            fi
            "

      # ÊòæÁ§∫ÈÉ®ÁΩ≤‰ø°ÊÅØ
      - name: Deployment summary
        if: always()
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            echo '========================================='
            echo '  Backend Deployment Summary'
            echo '========================================='
            echo 'Deployed to: /home/apps/open-api'
            echo 'PM2 Status:'
            pm2 list | grep open-api || echo 'Service not found'
            echo '========================================='
            "
